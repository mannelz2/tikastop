import{i as s,r as d}from"./utm-helper-C4jEGc4L.js";/* empty css                  */import{g as l,a as m}from"./pix-preloader-tP1izpQF.js";s();const g="https://tbmhixbambsdenkxjdlz.supabase.co",p="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRibWhpeGJhbWJzZGVua3hqZGx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzQwMjUsImV4cCI6MjA4MDU1MDAyNX0.C3xXc9utoJFguYXSEHtSEjI4p6Shnx7e3tfmK5o7dP4";let r=null,n=null;function u(){try{const e=localStorage.getItem("userPixData");if(e)return JSON.parse(e)}catch(e){console.error("Erro ao ler dados do localStorage",e)}return null}function f(e){document.getElementById("loading").style.display="none";const t=document.getElementById("error-message");t.innerHTML=`<i class="fas fa-exclamation-circle"></i> ${e}`,t.style.display="block"}async function y(){try{if(!u())throw new Error("Dados do formulário não encontrados");const t=document.getElementById("loading-text");return t&&(t.textContent="Carregando pagamento..."),await l("initial")}catch(e){throw console.error("Erro ao criar PIX:",e),e}}function I(e){if(console.log("PIX gerado com sucesso:",e),r=e.transactionId,document.getElementById("loading").style.display="none",document.getElementById("payment-content").style.display="block",document.getElementById("amount").textContent=`R$ ${e.amount.toFixed(2).replace(".",",")}`,e.expirationDate){const o=new Date(e.expirationDate).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});document.getElementById("expiration").textContent=o}else{const o=new Date(Date.now()+18e5).toLocaleString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});document.getElementById("expiration").textContent=o}if(document.getElementById("pix-code").value=e.qrcode,e.qrcodeImageUrl){const t=document.getElementById("qrcode"),o=document.createElement("img");o.src=e.qrcodeImageUrl,o.alt="QR Code PIX",o.style.width="200px",o.style.height="200px",t.appendChild(o),console.log("QR code pré-renderizado carregado do cache")}else if(typeof QRCode<"u"&&QRCode.toCanvas){const t=document.createElement("canvas");document.getElementById("qrcode").appendChild(t),QRCode.toCanvas(t,e.qrcode,{width:200,margin:2,color:{dark:"#000000",light:"#ffffff"}},function(o){o&&(console.error("Erro ao gerar QRCode:",o),c(e.qrcode))})}else c(e.qrcode);document.getElementById("copy-btn").addEventListener("click",function(){const t=document.getElementById("pix-code");t.select(),t.setSelectionRange(0,99999),navigator.clipboard.writeText(t.value).then(()=>{const o=document.getElementById("copy-btn");o.innerHTML='<i class="fas fa-check"></i> <span>Copiado!</span>',o.classList.add("copied"),setTimeout(function(){o.innerHTML='<i class="far fa-copy"></i> <span>Copiar</span>',o.classList.remove("copied")},2e3),m().catch(a=>{console.error("Erro ao pré-carregar PIX upsell1:",a)})}).catch(o=>{console.error("Erro ao copiar:",o)})}),r&&x(r)}function c(e){const t=document.getElementById("qrcode-img");t.src=`https://quickchart.io/qr?text=${encodeURIComponent(e)}&size=200`,t.style.display="block",document.getElementById("qrcode").style.display="none"}async function h(e){try{const t=`${g}/functions/v1/check-payment`,o={Authorization:`Bearer ${p}`,"Content-Type":"application/json"},i=await(await fetch(t,{method:"POST",headers:o,body:JSON.stringify({transactionId:e}),signal:AbortSignal.timeout(1e4)})).json();return i.status==="paid"||i.status==="approved"}catch(t){return console.error("[Pagamento] Erro ao verificar pagamento:",t),!1}}function x(e){n&&clearInterval(n),console.log(`[Pagamento] Iniciando verificação de pagamento para transação: ${e}`);let t=0;const o=120;n=setInterval(async()=>{if(t++,t>=o){console.log(`[Pagamento] Máximo de tentativas (${o}) atingido`),clearInterval(n);return}console.log(`[Pagamento] Tentativa ${t}/${o}`),await h(e)&&(console.log("[Pagamento] Pagamento confirmado! Redirecionando..."),clearInterval(n),d("/iof.html"))},3e3)}window.addEventListener("beforeunload",()=>{n&&clearInterval(n)});document.addEventListener("visibilitychange",()=>{document.hidden?console.log("[Pagamento] Página em background - polling continua"):console.log("[Pagamento] Página voltou ao foco")});document.addEventListener("DOMContentLoaded",async function(){try{const e=await y();I(e)}catch(e){f("Erro ao gerar PIX. Por favor, tente novamente."),console.error(e)}});
